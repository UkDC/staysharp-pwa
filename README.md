# StaySharp_PWA

PWA-калькулятор углов заточки и хонингования для Tormek с журналом заточек и облачной синхронизацией через Google Sheets + Apps Script.

[Live](https://ukdc.github.io/staysharp-pwa/)

## Что в проекте сейчас
- Калькулятор USH/FVB_H (Grinding/Honing).
- Журнал заточек с локальным хранением, очередью изменений и двусторонней синхронизацией.
- Справочник ножей (Database) с локальным кэшем и ручным обновлением из Google Sheets.
- Вкладка `Подбор Угла` с логикой, повторяющей базовый StaySharp.
- PWA (Service Worker, offline, обновление ассетов, принудительное обновление из интерфейса).
- Защита от дублей, потерь при синхронизации и конфликтов редактирования.

## User Guide

### Боковое меню
- `clearCache` сбрасывает только локальный кеш справочника (`staysharp_database`) и пересобирает его из встроенной базы.
- `update PWA` очищает web cache / Service Worker cache и перезапускает приложение.
- Для iPhone и iPad `update PWA` является основным способом подтянуть свежую версию интерфейса.
- Для desktop-браузера принудительное обновление также можно сделать через `Cmd+Shift+R`.

### Журнал
- Журнал хранится локально в `localStorage` (`staysharp_history`).
- Для ручной синхронизации Журнала:
  - на iPhone/iPad используйте жест pull-down: откройте Журнал, дойдите до самого верха и потяните экран вниз;
  - в desktop-браузере используйте кнопку `Sync` в заголовке раздела.
- Ручной sync Журнала является "полным" восстановительным проходом: он запрашивает актуальный снапшот `History`, а не только delta.
- Любые `add/update/delete` также пишутся в локальную outbox-очередь и отправляются в фоне.

### Справочник
- Справочник хранится локально в `staysharp_database`.
- Для ручного обновления Справочника:
  - на iPhone/iPad используйте жест pull-down;
  - в desktop-браузере используйте кнопку `Sync` в заголовке раздела.
- `clearCache` не удаляет журнал и не делает полный сброс браузерного кеша.

### Подбор Угла
- Логика соответствует базовому проекту `/Users/ip/My_Files/AI/StaySharp`.
- Алгоритм использует три шага:
  1. `Brand / Series / Steel`
  2. `Carbon / CrMoV`
  3. `Category`
- Для `Brand / Series / Steel` используется собственный autocomplete вместо нативного `datalist`.
- Если значение для поля отсутствует, используется явный маркер `неизвестно`.
- При переносе результата в профиль `неизвестно` не записывается как реальное значение.

## Sync / Data Model
- Любые изменения журнала (`add/update/delete`) пишутся в outbox-очередь (`staysharp_cloud_outbox`).
- Очередь отправляется сразу после изменений и ретраится в фоне.
- Pull из облака делает merge, а не слепой overwrite.
- После первой полной синхронизации Журнал запрашивается дельтой по `UpdatedAt`, а не всегда целиком.
- Если delta-ответ показывает расхождение по `ID` или внезапно пустое облако, клиент автоматически делает подтверждающий полный fetch `History`.
- Конфликты решаются по `UpdatedAt` (`last edit wins`).
- Удаления между устройствами распространяются через:
  - удаление строки в облаке (`hard delete`);
  - сравнение облачного снапшота по ID;
  - локальный реестр удалённых ID с TTL (`staysharp_deleted_ids`).
- Защита от аварийной потери: если облако внезапно вернуло пустой список в небезопасном delta-сценарии, массовое удаление локальных данных блокируется.
- Если пустой ответ подтверждён полным fetch, пустой `History` считается валидным и синхронизируется на клиент.

## Admin / Backend

### Требования к Google Sheet
Лист `History` должен иметь шапку в первой строке. Рекомендуемый порядок:

1. `ID`
2. `Date`
3. `Brand`
4. `Series`
5. `Steel`
6. `C, %`
7. `CrMoV, %`
8. `Length`
9. `Width`
10. `Sharp. angle (double)`
11. `Honing add`
12. `BESS g`
13. `Comments`
14. `UpdatedAt`

Важно:
- `ID` обязателен для корректного `update/delete`.
- `UpdatedAt` обязателен для `last edit wins`.
- Колонку `ID` можно скрыть в таблице.
- Если шапка отсутствует, записи из приложения не будут корректно маппиться.
- При ручном вводе строк в Google Sheet backend может автоматически проставлять `ID`, `Date`, `UpdatedAt` через `onEdit`.
- При чтении `History` backend также умеет автоматически добивать отсутствующие `ID / Date / UpdatedAt` в legacy-строках.

Лист `Database` также должен существовать и содержать рабочую шапку справочника. Пустой или удалённый лист `Database` ломает обновление справочника.

### Backend (Apps Script)
Исходник backend хранится в репозитории:

- [Code.gs](backend/google-apps-script/Code.gs)
- [backend/google-apps-script/README.md](backend/google-apps-script/README.md)
- [Рабочая Google Sheet](https://docs.google.com/spreadsheets/d/1jh-aitRUzKT4eAqRz4pB_cvPWenxLhInXtyQrJLxjFU/edit?usp=sharing)

Обязательно:
- В `Script Properties` задать `API_TOKEN`.
- Значение токена в Apps Script должно совпадать с токеном, который использует клиент.
- После изменений делать новый `Web App Deploy` (New version).
- Для автоматического заполнения `ID / Date / UpdatedAt` при ручном вводе строк рекомендуется включить `onEdit`, хотя чтение `History` также умеет подхватывать legacy-строки без этих полей.

### Локальная разработка
```bash
cd StaySharp_PWA
python3 -m http.server 4173
```

### Публикация (GitHub Pages)
Основной рабочий способ публикации:
```bash
cd StaySharp_PWA
./deploy.sh "описание изменений"
```

Что делает `deploy.sh`:
- обновляет build/cache version в `sw.js`, `index.html`,
- коммитит все изменения,
- пушит в `main`.

## Траблшутинг
- Кнопка "Сохранить" не реагирует:
  - открыть Console и проверить ошибки JS,
  - проверить `typeof window.saveRecordClick` (должно быть `function`).
- Запись не уходит в Google Sheet:
  - проверить, что у `History` есть корректная шапка,
  - проверить актуальный deploy Apps Script,
  - проверить токен в `Script Properties`.
- Pull-down синхронизация в Журнале обнуляет локальный журнал:
  - сначала проверить ответ Apps Script,
  - убедиться, что `History` не пустой только из-за сломанной шапки,
  - проверить, что `UpdatedAt` реально заполняется.
- Ручной sync в браузере не виден:
  - проверить, что открыт актуальный build,
  - в разделах Журнал и Справочник в desktop-версии должна быть кнопка `Sync` в заголовке.
- На iPhone не подтягивается новая версия интерфейса:
  - нажать `update PWA`,
  - если нужно, затем полностью закрыть и снова открыть PWA.
- `clearCache` не "чистит всё":
  - это ожидаемо, кнопка сбрасывает только локальный кеш справочника.
- Разный формат даты в журнале:
  - в клиенте включена нормализация, ISO и текстовые значения приводятся к читаемому виду.

## Структура
```text
index.html
css/style.css
js/app.js
js/knives.js
sw.js
manifest.json
backend/google-apps-script/Code.gs
```

## Лицензия
Личный проект.
